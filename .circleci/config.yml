version: 2.1

orbs:
  aws-cli: circleci/aws-cli@3.1
  aws-eks: circleci/aws-eks@2.2.0
  kubernetes: circleci/kubernetes@1.3.1


jobs:
  deploy:
    executor: aws-cli/default
    steps:
      - checkout
      - kubernetes/install-kubectl
      - aws-cli/setup:
          aws-access-key-id: AWS_ACCESS_KEY_ID
          aws-secret-access-key: AWS_SECRET_ACCESS_KEY
          aws-region: AWS_DEFAULT_REGION

      # Build and test your application here

      # Authenticate with EKS
      # - aws-eks/eks-authenticate:
      #     cluster-name: eks-dev-cluster
      #     region: ap-south-1

      # Install Helm and deploy the application
      # - helm/install-helm
      # - helm/upgrade-chart:
      #     chart: my-helm-chart
      #     release-name: my-release-name
      #     namespace: my-namespace
      #     values: |
      #       image:
      #         tag: $CIRCLE_SHA1
      #       service:
      #         type: LoadBalancer
      #       replicas: 3
      - aws-eks/update-kubeconfig-with-authenticator:
          cluster-name: eks-dev-cluster
      - run:
          command: |
            kubectl get services
          name: Test cluster
      - run:
          command: |
            helm ls
          name: Test Helm
      - run:
          command: aws s3 ls
          name: aws s3 ls
workflows:
  main:
    jobs:
      - deploy:
          context: aws-credentials-context